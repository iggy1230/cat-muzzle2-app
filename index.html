<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Muzzle AI - 3D Perspective</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #fff; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: #2d2d2d; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 100%; max-width: 600px; text-align: center; }
        #log { margin: 15px 0; padding: 12px; background: #000; color: #00ff00; font-family: monospace; font-size: 11px; border-radius: 8px; text-align: left; height: 100px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #444; }
        .preview-box { position: relative; width: 100%; background: #000; border-radius: 12px; margin-top: 15px; border: 2px solid #444; overflow: hidden; }
        canvas { max-width: 100%; height: auto; display: block; margin: 0 auto; }
        .btn { padding: 16px 32px; background: #7c4dff; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn:disabled { background: #444; cursor: wait; opacity: 0.6; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ± CAT MUZZLE AI (3D Perspective)</h2>
        <div id="log">ãƒ­ã‚°: ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
        
        <input type="file" id="fileInput" accept="image/*,video/*" hidden>
        <button id="uploadBtn" class="btn" disabled>èª­ã¿è¾¼ã¿ä¸­...</button>

        <div class="preview-box">
            <canvas id="canvas"></canvas>
            <video id="video" playsinline muted style="display:none;"></video>
        </div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const logArea = document.getElementById('log');

        function addLog(msg) {
            logArea.innerText += `> ${msg}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        let faceLandmarker;
        let muzzleImg = new Image();
        let muzzleReady = false;

        muzzleImg.src = "muzzle.png";
        muzzleImg.onload = () => { muzzleReady = true; addLog("muzzle.png èª­è¾¼å®Œäº†"); };

        async function init() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numFaces: 2,
                    minFaceDetectionConfidence: 0.3, // æ¤œå‡ºæ„Ÿåº¦ã‚’æœ€å¤§åŒ–
                    minTrackingConfidence: 0.3
                });
                addLog("AIã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™å®Œäº†");
                uploadBtn.disabled = false;
                uploadBtn.innerText = "å†™çœŸãƒ»å‹•ç”»ã‚’é¸æŠ";
                uploadBtn.onclick = () => fileInput.click();
            } catch (e) { addLog("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            if (file.type.startsWith('image/')) {
                const img = new Image();
                img.onload = async () => {
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const results = await faceLandmarker.detect(img);
                    if (results.faceLandmarks) results.faceLandmarks.forEach(drawMuzzle3D);
                };
                img.src = url;
            } else {
                video.src = url;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    video.play();
                    renderVideo();
                };
            }
        };

        async function renderVideo() {
            if (video.paused || video.ended) return;
            const results = faceLandmarker.detectForVideo(video, performance.now());
            ctx.drawImage(video, 0, 0);
            if (muzzleReady && results.faceLandmarks) {
                results.faceLandmarks.forEach(drawMuzzle3D);
            }
            requestAnimationFrame(renderVideo);
        }

        // --- æ”¹å–„ã•ã‚ŒãŸ3Dæç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        function drawMuzzle3D(landmarks) {
            const noseTip = landmarks[4];      // é¼»å…ˆ
            const noseBridge = landmarks[1];   // é¼»æ ¹ï¼ˆç›®ã¨ç›®ã®é–“ï¼‰
            const jawL = landmarks[234];       // å·¦é ¬
            const jawR = landmarks[454];       // å³é ¬
            const eyeL = landmarks[33];
            const eyeR = landmarks[263];

            // 1. æ¨ªã‚’å‘ã„ã¦ã„ã‚‹åº¦åˆã„ï¼ˆYawï¼‰ã‚’æ¨å®š
            // é¼»ãŒé¡”ã®ä¸­å¿ƒç·šã‹ã‚‰ã©ã‚Œã ã‘ã‚ºãƒ¬ã¦ã„ã‚‹ã‹ã‚’è¨ˆç®—
            const centerX = (jawL.x + jawR.x) / 2;
            const faceWidth2D = Math.abs(jawR.x - jawL.x);
            // ãƒ¨ã‚³å‘ãä¿‚æ•° (-1.0 ã€œ 1.0)
            const yawFactor = (noseTip.x - centerX) / (faceWidth2D / 2);

            // 2. å¥¥è¡Œãï¼ˆZï¼‰ã‚’è€ƒæ…®ã—ãŸã‚¹ã‚±ãƒ¼ãƒ«ç®—å‡º
            // æ¨ªã‚’å‘ã„ã¦ã‚‚å¤‰åŒ–ã—ã«ãã„ã€Œé¡”ã®3Då¹…ã€ã‚’æ“¬ä¼¼çš„ã«ç®—å‡º
            const faceWidth3D = Math.hypot(jawR.x - jawL.x, jawR.z - jawL.z) * canvas.width;
            
            // 3. å›è»¢è§’ï¼ˆRollï¼‰
            const angle = Math.atan2(eyeR.y - eyeL.y, eyeR.x - eyeL.x);

            // 4. ãƒ‘ãƒ¼ã‚¹è£œæ­£ã‚’é©ç”¨ã—ãŸã‚µã‚¤ã‚ºè¨­å®š
            const aspectRatio = muzzleImg.width / muzzleImg.height;
            const baseSize = faceWidth3D * 0.75;
            
            // é¡”ãŒæ¨ªã‚’å‘ãã»ã©æ¨ªå¹…ã‚’åœ§ç¸® (cosè¿‘ä¼¼)
            const squeezeFactor = Math.max(0.2, Math.cos(yawFactor * (Math.PI / 2.5)));
            const targetWidth = baseSize * squeezeFactor;
            const targetHeight = baseSize / aspectRatio;

            // 5. æç”»
            ctx.save();
            
            // é¼»å…ˆã«ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ç½®ã
            const x = noseTip.x * canvas.width;
            const y = noseTip.y * canvas.height;
            ctx.translate(x, y);
            
            // é¡”ã®å‚¾ã
            ctx.rotate(angle);

            // æ¨ªã‚’å‘ã„ã¦ã„ã‚‹æ–¹å‘ã«ãƒã‚ºãƒ«ã‚’å°‘ã—ã‚·ãƒ•ãƒˆï¼ˆç«‹ä½“çš„ãªé¼»ã®åšã¿ã‚’è¡¨ç¾ï¼‰
            const xOffset = (yawFactor * baseSize * 0.1);

            ctx.globalAlpha = 0.95; // é¦´æŸ“ã¿ã‚’è‰¯ãã™ã‚‹ãŸã‚ã«å°‘ã—é€é
            ctx.drawImage(
                muzzleImg, 
                -targetWidth / 2 + xOffset, 
                -targetHeight / 2 + (targetHeight * 0.1), 
                targetWidth, 
                targetHeight
            );
            
            ctx.restore();
        }

        init();
    </script>
</body>
</html>