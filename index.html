<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Muzzle AI - Stable</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f4f4f9; padding: 20px; }
        .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        canvas { max-width: 100%; border-radius: 10px; background: #000; margin-top: 10px; }
        .btn { padding: 12px 24px; background: #6200ee; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 15px; color: #555; font-weight: bold; }
        #downloadArea { margin-top: 15px; display: none; }
    </style>
    <!-- MediaPipeã®èª­ã¿è¾¼ã¿ã‚’ç¢ºå®Ÿã« -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ± Cat Muzzle AI</h1>
        <div id="status">ã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ä¸­...</div>
        
        <input type="file" id="fileInput" accept="image/*,video/*" hidden>
        <button id="uploadBtn" class="btn" disabled>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>

        <div id="downloadArea">
            <button id="downloadBtn" class="btn" style="background: #03dac6; color: #000;">ä¿å­˜ã™ã‚‹</button>
            <button onclick="location.reload()" class="btn" style="background: #eee; color: #333;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <canvas id="outputCanvas"></canvas>
        <video id="hiddenVideo" playsinline style="display:none;"></video>
    </div>

    <script>
        const { FaceLandmarker, FilesetResolver } = createFaceLandmarkerNamespace();
        
        let faceLandmarker;
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const status = document.getElementById('status');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('hiddenVideo');
        const downloadArea = document.getElementById('downloadArea');
        const downloadBtn = document.getElementById('downloadBtn');

        // ãƒã‚ºãƒ«ç”»åƒã®æº–å‚™ (ãƒ†ã‚¹ãƒˆç”¨ã«çŒ«ã®é¼»ã‚¢ã‚¤ã‚³ãƒ³ã®Base64)
        const muzzleImg = new Image();
        muzzleImg.src = "https://img.icons8.com/color/96/cat-nose.png"; 

        async function init() {
            try {
                status.innerText = "WASMã‚¨ãƒ³ã‚¸ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...";
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );
                
                status.innerText = "ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...";
                faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO", // ç”»åƒãƒ»å‹•ç”»ä¸¡ç”¨
                    numFaces: 2
                });

                status.innerText = "æº–å‚™å®Œäº†ï¼";
                uploadBtn.disabled = false;
                uploadBtn.onclick = () => fileInput.click();
                console.log("MediaPipe Ready");
            } catch (error) {
                status.innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: " + error.message;
                console.error(error);
            }
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            status.innerText = "å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...";
            const url = URL.createObjectURL(file);

            if (file.type.startsWith('image/')) {
                processImage(url);
            } else {
                processVideo(url);
            }
        });

        async function processImage(url) {
            const img = new Image();
            img.onload = async () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // æ¤œå‡º (ç”»åƒã§ã‚‚ detectForVideo ã‚’ä½¿ã†ã“ã¨ã§å…±é€šåŒ–)
                const results = faceLandmarker.detectForVideo(img, performance.now());
                if (results.faceLandmarks) {
                    results.faceLandmarks.forEach(drawMuzzle);
                }
                status.innerText = "å®Œäº†ï¼";
                showDownload(canvas.toDataURL('image/png'), 'cat_photo.png');
            };
            img.src = url;
        }

        async function processVideo(url) {
            video.src = url;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const stream = canvas.captureStream(30);
                const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    showDownload(URL.createObjectURL(blob), 'cat_video.webm');
                };

                recorder.start();
                video.play();
                
                async function render() {
                    if (video.paused || video.ended) {
                        recorder.stop();
                        status.innerText = "æ›¸ãå‡ºã—å®Œäº†ï¼";
                        return;
                    }
                    ctx.drawImage(video, 0, 0);
                    const results = faceLandmarker.detectForVideo(video, performance.now());
                    if (results.faceLandmarks) {
                        results.faceLandmarks.forEach(drawMuzzle);
                    }
                    requestAnimationFrame(render);
                }
                render();
            };
        }

        function drawMuzzle(landmarks) {
            const nose = landmarks[4]; // é¼»ã®é ­
            const jawR = landmarks[234];
            const jawL = landmarks[454];
            const eyeR = landmarks[33];
            const eyeL = landmarks[263];

            const faceWidth = Math.hypot(jawL.x - jawR.x, jawL.y - jawR.y) * canvas.width;
            const angle = Math.atan2(eyeL.y - eyeR.y, eyeL.x - eyeR.x);
            const size = faceWidth * 0.5;

            ctx.save();
            ctx.translate(nose.x * canvas.width, nose.y * canvas.height);
            ctx.rotate(angle);
            ctx.drawImage(muzzleImg, -size/2, -size/2, size, size);
            ctx.restore();
        }

        function showDownload(url, name) {
            downloadArea.style.display = 'block';
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
            };
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: CDNã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åå‰ç©ºé–“ã¨ã—ã¦å–å¾—
        function createFaceLandmarkerNamespace() {
            return {
                FaceLandmarker: mpVision.FaceLandmarker,
                FilesetResolver: mpVision.FilesetResolver
            };
        }

        init();
    </script>
</body>
</html>