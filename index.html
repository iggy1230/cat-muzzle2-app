<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Muzzle AI - Stable v2</title>
    <style>
        :root { --p: #6200ee; --s: #03dac6; }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        #status { margin: 15px 0; padding: 10px; border-radius: 8px; background: #eee; font-size: 14px; min-height: 1.2em; }
        .preview-box { position: relative; width: 100%; background: #000; border-radius: 12px; overflow: hidden; margin-top: 15px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        canvas { max-width: 100%; height: auto; display: block; }
        .btn { padding: 14px 28px; background: var(--p); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; width: 100%; }
        .btn:disabled { background: #ccc; }
        #dlBtn { background: var(--s); color: #000; margin-top: 10px; display: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="card">
        <h2>ğŸ± çŒ«ãƒã‚ºãƒ«åˆæˆAI</h2>
        <div id="status">ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...</div>
        
        <input type="file" id="fileInput" accept="image/*,video/*" hidden>
        <button id="uploadBtn" class="btn" disabled>ç”»åƒãƒ»å‹•ç”»ã‚’é¸æŠ</button>
        <button id="dlBtn" class="btn">çµæœã‚’ä¿å­˜ã™ã‚‹</button>

        <div class="preview-box">
            <canvas id="canvas"></canvas>
            <video id="video" playsinline hidden></video>
        </div>
    </div>

    <script>
        const { FaceLandmarker, FilesetResolver } = mpVision;
        let landmarker;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const uploadBtn = document.getElementById('uploadBtn');
        const dlBtn = document.getElementById('dlBtn');

        // çŒ«ã®ãƒã‚ºãƒ«ç”»åƒ (Base64ã§ç›´æ¥åŸ‹ã‚è¾¼ã¿) - ã‚·ãƒ³ãƒ—ãƒ«ãªçŒ«ã®é¼»
        const muzzleImg = new Image();
        muzzleImg.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAADXklEQVR4nO2dS24TQRCGP8MYI8mCyA0SByBCOAtH4S4sgSByAs4SByBEnSByAs6SByAsnSByAs4SByAknSDJAicS78LIsmS7Z7p7qqfH6reSNo9X9Vf1V01399BCoVCoVCqVSpXGNoA9YAt4BbwArvK6D7wC9uY6XpDWAXvAnS9v/Hl16T9NAdp0C7gD3unfX096rIBtAF/076+nvYmX6K3989vST0E/0Vv7569KnwN9pX9+Tfrv6E308+uS0pvg5f6N7unfTToS+Ar84v9X9G9WpZ0S6Vv9G8vS7iPpx/0bR6X9Uul7/Rvr0m4g6Z7+zVHpV6S/07+xKe17kr7Wv7Ep7TqSrtK/uSrtM9LH9G96pf1A+pj+Ta+0f0gf07/plfYL6WP6N73SrqR/H73v0z8vSrtIurR/m9F2Anynf76v9DHp0v5tRtsW8IP++anSV6RL+7cZbUfAL/rn16SrkS7t32a07SAnvD/SdfP6qfR3pEv7txltY97f6Xp6vC/9Wul3pEv7txltd8B7vVp3unE6R9p30Uv7txntAfBAX9vOnPZp9NL+bUab8p34on9+TvoV6dL+bUbbpZf30W9vSvoZ6dL+bUZbV87N7+lfD0q/IF3av81oO86p+T39637pI9Kl/duMtmvgV87X7+lf90uX9m8z2i7UfO3R8v9XpEv7txltK8AnuS6XpY9Jl/ZvM9pUvYf0L5alX5Eu7d9mtN2reU6/uSrtIunS/m1Gu9PrX77Xv3ksfUy6tH+b0XatXv/V7vRvHksfky7t32a0Oa/v6V8XSR+TLu3fZrT9Bv6o6fN7+te90sekS/u3GW3f9G8vS/uepEv7txltZ6L7+reD0j4nXdG/GW3Xoov0bwvSz0iX9m8z2i7lXPyZ/u2gtM9Il/ZvM9ou5Vz8mf7toLTPSJf2bTPaluX8/Jn+db/0X6RL+7YZbd/y6V/3Sv9FurRvm9F2LqL0rxvS/5Eu7dtmtD0Cnun30Yf696vSv5Eu7dtmtD0W677+fVn6N9KlfduMthNxl9LvpX8lXdq3zWgbAn88/UvX0r9OlfZtM9qU95K+l3QeStv/5v9C59/9uS6VSqVSqVQqlfL7B4r9M7T9Tf7mAAAAAElFTkSuQmCC";

        // åˆæœŸåŒ–
        async function setup() {
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );
                landmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                        delegate: "GPU"
                    },
                    runningMode: "IMAGE", // åˆæœŸã¯ç”»åƒãƒ¢ãƒ¼ãƒ‰
                    numFaces: 2
                });
                status.innerText = "æº–å‚™å®Œäº†ã€‚ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
                uploadBtn.disabled = false;
                uploadBtn.onclick = () => fileInput.click();
            } catch (e) {
                status.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message;
            }
        }

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            status.innerText = "èª­ã¿è¾¼ã¿ä¸­...";
            dlBtn.style.display = 'none';

            if (file.type.startsWith('image/')) {
                await processImage(url);
            } else {
                await processVideo(url);
            }
        };

        async function processImage(url) {
            const img = new Image();
            img.src = url;
            await img.decode();

            // é•·è¾ºã‚’1280pxã«ãƒªã‚µã‚¤ã‚ºï¼ˆè² è·å¯¾ç­–ï¼‰
            const maxLen = 1280;
            let w = img.width;
            let h = img.height;
            if (w > maxLen || h > maxLen) {
                const ratio = maxLen / Math.max(w, h);
                w *= ratio; h *= ratio;
            }
            canvas.width = w;
            canvas.height = h;

            status.innerText = "é¡”ã‚’æ¤œå‡ºä¸­...";
            await landmarker.setOptions({ runningMode: "IMAGE" });
            const results = await landmarker.detect(img);

            ctx.drawImage(img, 0, 0, w, h);
            if (results.faceLandmarks) {
                results.faceLandmarks.forEach(landmarks => drawMuzzle(landmarks));
                status.innerText = "åˆæˆå®Œäº†ï¼";
                dlBtn.style.display = 'block';
                dlBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.download = 'cat_photo.png';
                    link.href = canvas.toDataURL();
                    link.click();
                };
            } else {
                status.innerText = "é¡”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
            }
        }

        async function processVideo(url) {
            video.src = url;
            await video.load();
            status.innerText = "å‹•ç”»å‡¦ç†ä¸­...";
            
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const stream = canvas.captureStream();
                const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    dlBtn.style.display = 'block';
                    dlBtn.onclick = () => {
                        const link = document.createElement('a');
                        link.download = 'cat_video.webm';
                        link.href = URL.createObjectURL(blob);
                        link.click();
                    };
                    status.innerText = "å®Œäº†ï¼";
                };

                recorder.start();
                video.play();
                renderVideo();

                async function renderVideo() {
                    if (video.paused || video.ended) {
                        recorder.stop();
                        return;
                    }
                    await landmarker.setOptions({ runningMode: "VIDEO" });
                    const results = landmarker.detectForVideo(video, performance.now());
                    
                    ctx.drawImage(video, 0, 0);
                    if (results.faceLandmarks) {
                        results.faceLandmarks.forEach(landmarks => drawMuzzle(landmarks));
                    }
                    requestAnimationFrame(renderVideo);
                }
            };
        }

        function drawMuzzle(landmarks) {
            const nose = landmarks[4];
            const eyeL = landmarks[33], eyeR = landmarks[263];
            const jawL = landmarks[234], jawR = landmarks[454];

            const faceWidth = Math.hypot(jawR.x - jawL.x, jawR.y - jawL.y) * canvas.width;
            const angle = Math.atan2(eyeR.y - eyeL.y, eyeR.x - eyeL.x);
            const size = faceWidth * 0.5;

            ctx.save();
            ctx.translate(nose.x * canvas.width, nose.y * canvas.height);
            ctx.rotate(angle);
            ctx.drawImage(muzzleImg, -size/2, -size/2, size, size);
            ctx.restore();
        }

        setup();
    </script>
</body>
</html>