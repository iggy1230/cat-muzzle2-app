<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Muzzle AI - Debug Mode</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        #log { margin: 10px 0; padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 12px; border-radius: 5px; text-align: left; height: 100px; overflow-y: auto; }
        .preview-box { position: relative; width: 100%; background: #eee; border-radius: 12px; margin-top: 15px; min-height: 200px; }
        canvas { max-width: 100%; height: auto; border-radius: 12px; }
        .btn { padding: 14px 28px; background: #6200ee; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px; }
        .btn:disabled { background: #ccc; cursor: wait; }
    </style>
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="card">
        <h2>ğŸ± çŒ«ãƒã‚ºãƒ«åˆæˆ (å®‰å®šç‰ˆ)</h2>
        <div id="log">ãƒ­ã‚°: ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ã‚’å¾…æ©Ÿä¸­...</div>
        
        <input type="file" id="fileInput" accept="image/*,video/*" hidden>
        <button id="uploadBtn" class="btn" disabled>ã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿ä¸­...</button>
        <button id="dlBtn" class="btn" style="background:#03dac6; color:#000; display:none;">ç”»åƒã‚’ä¿å­˜ã™ã‚‹</button>

        <div class="preview-box">
            <canvas id="canvas"></canvas>
            <video id="video" playsinline hidden></video>
        </div>
    </div>

    <script>
        const logArea = document.getElementById('log');
        function addLog(msg) {
            logArea.innerHTML += `> ${msg}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(msg);
        }

        let faceLandmarker;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const dlBtn = document.getElementById('dlBtn');

        // ã‚·ãƒ³ãƒ—ãƒ«ãªçŒ«ã®é¼»ï¼ˆBase64ï¼‰
        const muzzleImg = new Image();
        muzzleImg.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAADXklEQVR4nO2dS24TQRCGP8MYI8mCyA0SByBCOAtH4S4sgSByAs4SByBEnSByAs6SByAsnSByAs4SByAknSDJAicS78LIsmS7Z7p7qqfH6reSNo9X9Vf1V01399BCoVCoVCqVSpXGNoA9YAt4BbwArvK6D7wC9uY6XpDWAXvAnS9v/Hl16T9NAdp0C7gD3unfX096rIBtAF/076+nvYmX6K3989vST0E/0Vv7569KnwN9pX9+Tfrv6E308+uS0pvg5f6N7unfTToS+Ar84v9X9G9WpZ0S6Vv9G8vS7iPpx/0bR6X9Uul7/Rvr0m4g6Z7+zVHpV6S/07+xKe17kr7Wv7Ep7TqSrtK/uSrtM9LH9G96pf1A+pj+Ta+0f0gf07/plfYL6WP6N73SrqR/H73v0z8vSrtIurR/m9F2Anynf76v9DHp0v5tRtsW8IP++anSV6RL+7cZbUfAL/rn16SrkS7t32a07SAnvD/SdfP6qfR3pEv7txltY97f6Xp6vC/9Wul3pEv7txltd8B7vVp3unE6R9p30Uv7txntAfBAX9vOnPZp9NL+bUab8p34on9+TvoV6dL+bUbbpZf30W9vSvoZ6dL+bUZbV87N7+lfD0q/IF3av81oO86p+T39637pI9Kl/duMtmvgV87X7+lf90uX9m8z2i7UfO3R8v9XpEv7txltK8AnuS6XpY9Jl/ZvM9pUvYf0L5alX5Eu7d9mtN2reU6/uSrtIunS/m1Gu9PrX77Xv3ksfUy6tH+b0XatXv/V7vRvHksfky7t32a0Oa/v6V8XSR+TLu3fZrT9Bv6o6fN7+te90sekS/u3GW3f9G8vS/uepEv7txltW2J7+reD0j4nXdG/GW3Xoov0bwvSz0iX9m8z2i7lXPyZ/u2gtM9Il/ZvM9ou5Vz8mf7toLTPSJf2bTPaluX8/Jn+db/0X6RL+7YZbd/y6V/3Sv9FurRvm9F2LqL0rxvS/5Eu7dtmtD0Cnun30Yf696vSv5Eu7dtmtD0W677+fVn6N9KlfduMthNxl9LvpX8lXdq3zWgbAn88/UvX0r9OlfZtM9qU95K+l3QeStv/5v9C59/9uS6VSqVSqVQqlfL7B4r9M7T9Tf7mAAAAAElFTkSuQmCC";

        async function init() {
            try {
                addLog("WASMãƒªã‚¾ãƒ«ãƒãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...");
                const vision = await mpVision.FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );
                
                addLog("AIãƒ¢ãƒ‡ãƒ«(80MB)ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰");
                faceLandmarker = await mpVision.FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                        delegate: "CPU" // å®‰å®šæ€§ã®ãŸã‚CPUã‚’ä½¿ç”¨
                    },
                    runningMode: "IMAGE",
                    numFaces: 2
                });

                addLog("æº–å‚™å®Œäº†ï¼");
                uploadBtn.innerText = "ç”»åƒãƒ»å‹•ç”»ã‚’é¸æŠ";
                uploadBtn.disabled = false;
                uploadBtn.onclick = () => fileInput.click();
            } catch (e) {
                addLog("è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: " + e.message);
                console.error(e);
            }
        }

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            addLog(`ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡: ${file.name} (${file.type})`);
            const url = URL.createObjectURL(file);
            dlBtn.style.display = 'none';

            if (file.type.startsWith('image/')) {
                processImage(url);
            } else {
                processVideo(url);
            }
        };

        async function processImage(url) {
            addLog("ç”»åƒã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­...");
            const img = new Image();
            img.src = url;
            await img.decode();

            // ãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼ˆãƒ¡ãƒ¢ãƒªå¯¾ç­–ï¼‰
            const max = 1024;
            let w = img.width, h = img.height;
            if (w > max || h > max) {
                const s = max / Math.max(w, h);
                w *= s; h *= s;
            }
            canvas.width = w; canvas.height = h;
            
            addLog("AIè§£æå®Ÿè¡Œä¸­...");
            await faceLandmarker.setOptions({ runningMode: "IMAGE" });
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œ
            const results = await faceLandmarker.detect(img);
            
            ctx.drawImage(img, 0, 0, w, h);
            if (results.faceLandmarks && results.faceLandmarks.length > 0) {
                addLog(`${results.faceLandmarks.length}äººã®é¡”ã‚’æ¤œå‡ºã€‚ãƒã‚ºãƒ«ã‚’åˆæˆã—ã¾ã™ã€‚`);
                results.faceLandmarks.forEach(drawMuzzle);
                addLog("å®Œäº†ï¼");
                dlBtn.style.display = 'block';
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.download = 'result.png';
                    a.href = canvas.toDataURL();
                    a.click();
                };
            } else {
                addLog("è­¦å‘Š: é¡”ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æ­£é¢ã‚’å‘ã„ãŸç”»åƒã‚’ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        }

        async function processVideo(url) {
            addLog("å‹•ç”»ã®æº–å‚™ä¸­...");
            video.src = url;
            await video.load();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                addLog("å‹•ç”»è§£æã‚’é–‹å§‹ã—ã¾ã™ã€‚å†ç”Ÿçµ‚äº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚");
                video.play();
                renderVideo();
            };
        }

        async function renderVideo() {
            if (video.paused || video.ended) {
                addLog("å‹•ç”»å‡¦ç†ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚");
                return;
            }
            await faceLandmarker.setOptions({ runningMode: "VIDEO" });
            const results = faceLandmarker.detectForVideo(video, performance.now());
            
            ctx.drawImage(video, 0, 0);
            if (results.faceLandmarks) {
                results.faceLandmarks.forEach(drawMuzzle);
            }
            requestAnimationFrame(renderVideo);
        }

        function drawMuzzle(landmarks) {
            const nose = landmarks[4];
            const eyeL = landmarks[33], eyeR = landmarks[263];
            const jawL = landmarks[234], jawR = landmarks[454];

            const faceWidth = Math.hypot(jawR.x - jawL.x, jawR.y - jawL.y) * canvas.width;
            const angle = Math.atan2(eyeR.y - eyeL.y, eyeR.x - eyeL.x);
            const size = faceWidth * 0.5;

            ctx.save();
            ctx.translate(nose.x * canvas.width, nose.y * canvas.height);
            ctx.rotate(angle);
            ctx.drawImage(muzzleImg, -size/2, -size/2, size, size);
            ctx.restore();
        }

        init();
    </script>
</body>
</html>